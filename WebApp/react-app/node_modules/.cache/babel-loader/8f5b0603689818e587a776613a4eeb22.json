{"ast":null,"code":"\"use strict\";\n/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\n\nvar __assign = this && this.__assign || Object.assign || function (t) {\n  for (var s, i = 1, n = arguments.length; i < n; i++) {\n    s = arguments[i];\n\n    for (var p in s) {\n      if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n  }\n\n  return t;\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Logger_1 = require(\"./Logger\");\n\nvar Facet_1 = require(\"./Facet\");\n\nvar logger = new Logger_1.ConsoleLogger('Signer'),\n    url = require('url'),\n    crypto = Facet_1.AWS['util'].crypto;\n\nvar DEFAULT_ALGORITHM = 'AWS4-HMAC-SHA256';\nvar IOT_SERVICE_NAME = 'iotdevicegateway';\n\nvar encrypt = function encrypt(key, src, encoding) {\n  return crypto.lib.createHmac('sha256', key).update(src, 'utf8').digest(encoding);\n};\n\nvar hash = function hash(src) {\n  var arg = src || '';\n  return crypto.createHash('sha256').update(arg, 'utf8').digest('hex');\n};\n/**\n * @private\n * RFC 3986 compliant version of encodeURIComponent\n */\n\n\nvar escape_RFC3986 = function escape_RFC3986(component) {\n  return component.replace(/[!'()*]/g, function (c) {\n    return '%' + c.charCodeAt(0).toString(16).toUpperCase();\n  });\n};\n/**\n * @private\n * Create canonical query string\n *\n*/\n\n\nvar canonical_query = function canonical_query(query) {\n  if (!query || query.length === 0) {\n    return '';\n  }\n\n  return query.split('&').map(function (e) {\n    var key_val = e.split('=');\n\n    if (key_val.length === 1) {\n      return e;\n    } else {\n      var reencoded_val = escape_RFC3986(key_val[1]);\n      return key_val[0] + '=' + reencoded_val;\n    }\n  }).sort(function (a, b) {\n    return a < b ? -1 : 1;\n  }).join('&');\n};\n/**\n* @private\n* Create canonical headers\n*\n<pre>\nCanonicalHeaders =\n    CanonicalHeadersEntry0 + CanonicalHeadersEntry1 + ... + CanonicalHeadersEntryN\nCanonicalHeadersEntry =\n    Lowercase(HeaderName) + ':' + Trimall(HeaderValue) + '\\n'\n</pre>\n*/\n\n\nvar canonical_headers = function canonical_headers(headers) {\n  if (!headers || Object.keys(headers).length === 0) {\n    return '';\n  }\n\n  return Object.keys(headers).map(function (key) {\n    return {\n      key: key.toLowerCase(),\n      value: headers[key] ? headers[key].trim().replace(/\\s+/g, ' ') : ''\n    };\n  }).sort(function (a, b) {\n    return a.key < b.key ? -1 : 1;\n  }).map(function (item) {\n    return item.key + ':' + item.value;\n  }).join('\\n') + '\\n';\n};\n/**\n* List of header keys included in the canonical headers.\n* @access private\n*/\n\n\nvar signed_headers = function signed_headers(headers) {\n  return Object.keys(headers).map(function (key) {\n    return key.toLowerCase();\n  }).sort().join(';');\n};\n/**\n* @private\n* Create canonical request\n* Refer to\n* {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-create-canonical-request.html|Create a Canonical Request}\n*\n<pre>\nCanonicalRequest =\n    HTTPRequestMethod + '\\n' +\n    CanonicalURI + '\\n' +\n    CanonicalQueryString + '\\n' +\n    CanonicalHeaders + '\\n' +\n    SignedHeaders + '\\n' +\n    HexEncode(Hash(RequestPayload))\n</pre>\n*/\n\n\nvar canonical_request = function canonical_request(request) {\n  var url_info = url.parse(request.url);\n  return [request.method || '/', encodeURIComponent(url_info.pathname).replace(/%2F/ig, '/'), canonical_query(url_info.query), canonical_headers(request.headers), signed_headers(request.headers), hash(request.data)].join('\\n');\n};\n\nvar parse_service_info = function parse_service_info(request) {\n  var url_info = url.parse(request.url),\n      host = url_info.host;\n  var matched = host.match(/([^\\.]+)\\.(?:([^\\.]*)\\.)?amazonaws\\.com$/);\n  var parsed = (matched || []).slice(1, 3);\n\n  if (parsed[1] === 'es') {\n    // Elastic Search\n    parsed = parsed.reverse();\n  }\n\n  return {\n    service: request.service || parsed[0],\n    region: request.region || parsed[1]\n  };\n};\n\nvar credential_scope = function credential_scope(d_str, region, service) {\n  return [d_str, region, service, 'aws4_request'].join('/');\n};\n/**\n* @private\n* Create a string to sign\n* Refer to\n* {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-create-string-to-sign.html|Create String to Sign}\n*\n<pre>\nStringToSign =\n    Algorithm + \\n +\n    RequestDateTime + \\n +\n    CredentialScope + \\n +\n    HashedCanonicalRequest\n</pre>\n*/\n\n\nvar string_to_sign = function string_to_sign(algorithm, canonical_request, dt_str, scope) {\n  return [algorithm, dt_str, scope, hash(canonical_request)].join('\\n');\n};\n/**\n* @private\n* Create signing key\n* Refer to\n* {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-calculate-signature.html|Calculate Signature}\n*\n<pre>\nkSecret = your secret access key\nkDate = HMAC(\"AWS4\" + kSecret, Date)\nkRegion = HMAC(kDate, Region)\nkService = HMAC(kRegion, Service)\nkSigning = HMAC(kService, \"aws4_request\")\n</pre>\n*/\n\n\nvar get_signing_key = function get_signing_key(secret_key, d_str, service_info) {\n  logger.debug(service_info);\n  var k = 'AWS4' + secret_key,\n      k_date = encrypt(k, d_str),\n      k_region = encrypt(k_date, service_info.region),\n      k_service = encrypt(k_region, service_info.service),\n      k_signing = encrypt(k_service, 'aws4_request');\n  return k_signing;\n};\n\nvar get_signature = function get_signature(signing_key, str_to_sign) {\n  return encrypt(signing_key, str_to_sign, 'hex');\n};\n/**\n* @private\n* Create authorization header\n* Refer to\n* {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-add-signature-to-request.html|Add the Signing Information}\n*/\n\n\nvar get_authorization_header = function get_authorization_header(algorithm, access_key, scope, signed_headers, signature) {\n  return [algorithm + ' ' + 'Credential=' + access_key + '/' + scope, 'SignedHeaders=' + signed_headers, 'Signature=' + signature].join(', ');\n};\n/**\n* Sign a HTTP request, add 'Authorization' header to request param\n* @method sign\n* @memberof Signer\n* @static\n*\n* @param {object} request - HTTP request object\n<pre>\nrequest: {\n    method: GET | POST | PUT ...\n    url: ...,\n    headers: {\n        header1: ...\n    },\n    data: data\n}\n</pre>\n* @param {object} access_info - AWS access credential info\n<pre>\naccess_info: {\n    access_key: ...,\n    secret_key: ...,\n    session_token: ...\n}\n</pre>\n* @param {object} [service_info] - AWS service type and region, optional,\n*                                  if not provided then parse out from url\n<pre>\nservice_info: {\n    service: ...,\n    region: ...\n}\n</pre>\n*\n* @returns {object} Signed HTTP request\n*/\n\n\nvar sign = function sign(request, access_info, service_info) {\n  if (service_info === void 0) {\n    service_info = null;\n  }\n\n  request.headers = request.headers || {}; // datetime string and date string\n\n  var dt = new Date(),\n      dt_str = dt.toISOString().replace(/[:\\-]|\\.\\d{3}/g, ''),\n      d_str = dt_str.substr(0, 8);\n  var url_info = url.parse(request.url);\n  request.headers['host'] = url_info.host;\n  request.headers['x-amz-date'] = dt_str;\n\n  if (access_info.session_token) {\n    request.headers['X-Amz-Security-Token'] = access_info.session_token;\n  } // Task 1: Create a Canonical Request\n\n\n  var request_str = canonical_request(request);\n  logger.debug(request_str); // Task 2: Create a String to Sign\n\n  var serviceInfo = service_info || parse_service_info(request),\n      scope = credential_scope(d_str, serviceInfo.region, serviceInfo.service),\n      str_to_sign = string_to_sign(DEFAULT_ALGORITHM, request_str, dt_str, scope); // Task 3: Calculate the Signature\n\n  var signing_key = get_signing_key(access_info.secret_key, d_str, serviceInfo),\n      signature = get_signature(signing_key, str_to_sign); // Task 4: Adding the Signing information to the Request\n\n  var authorization_header = get_authorization_header(DEFAULT_ALGORITHM, access_info.access_key, scope, signed_headers(request.headers), signature);\n  request.headers['Authorization'] = authorization_header;\n  return request;\n};\n\nvar signUrl = function signUrl(urlToSign, accessInfo, serviceInfo, expiration) {\n  var now = new Date().toISOString().replace(/[:\\-]|\\.\\d{3}/g, '');\n  var today = now.substr(0, 8); // Intentionally discarding search\n\n  var _a = url.parse(urlToSign, true, true),\n      search = _a.search,\n      parsedUrl = __rest(_a, [\"search\"]);\n\n  var host = parsedUrl.host;\n  var signedHeaders = {\n    host: host\n  };\n\n  var _b = serviceInfo || parse_service_info({\n    url: url.format(parsedUrl)\n  }),\n      region = _b.region,\n      service = _b.service;\n\n  var credentialScope = credential_scope(today, region, service); // IoT service does not allow the session token in the canonical request\n  // https://docs.aws.amazon.com/general/latest/gr/sigv4-add-signature-to-request.html\n\n  var sessionTokenRequired = accessInfo.session_token && service !== IOT_SERVICE_NAME;\n\n  var queryParams = __assign({\n    'X-Amz-Algorithm': DEFAULT_ALGORITHM,\n    'X-Amz-Credential': [accessInfo.access_key, credentialScope].join('/'),\n    'X-Amz-Date': now.substr(0, 16)\n  }, sessionTokenRequired ? {\n    'X-Amz-Security-Token': \"\" + accessInfo.session_token\n  } : {}, expiration ? {\n    'X-Amz-Expires': \"\" + expiration\n  } : {}, {\n    'X-Amz-SignedHeaders': Object.keys(signedHeaders).join(',')\n  });\n\n  var canonicalRequest = canonical_request({\n    method: 'GET',\n    url: url.format(__assign({}, parsedUrl, {\n      query: __assign({}, parsedUrl.query, queryParams)\n    })),\n    headers: signedHeaders\n  });\n  var stringToSign = string_to_sign(DEFAULT_ALGORITHM, canonicalRequest, now, credentialScope);\n  var signing_key = get_signing_key(accessInfo.secret_key, today, {\n    region: region,\n    service: service\n  });\n  var signature = get_signature(signing_key, stringToSign);\n\n  var additionalQueryParams = __assign({\n    'X-Amz-Signature': signature\n  }, accessInfo.session_token && {\n    'X-Amz-Security-Token': accessInfo.session_token\n  });\n\n  var result = url.format({\n    protocol: parsedUrl.protocol,\n    slashes: true,\n    hostname: parsedUrl.hostname,\n    pathname: parsedUrl.pathname,\n    query: __assign({}, parsedUrl.query, queryParams, additionalQueryParams)\n  });\n  return result;\n};\n/**\n* AWS request signer.\n* Refer to {@link http://docs.aws.amazon.com/general/latest/gr/sigv4_signing.html|Signature Version 4}\n*\n* @class Signer\n*/\n\n\nvar Signer =\n/** @class */\nfunction () {\n  function Signer() {}\n\n  Signer.sign = sign;\n  Signer.signUrl = signUrl;\n  return Signer;\n}();\n\nexports.default = Signer;","map":null,"metadata":{},"sourceType":"script"}